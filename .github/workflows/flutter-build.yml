name: Flutter Windows Build

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  VCPKG_BINARY_SOURCES: "clear;files,${{ github.workspace }}/vcpkg_cache,readwrite"

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      # ======================================
      # نصب ابزارها
      # ======================================
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc
      
      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "15.0"
          directory: ${{ github.workspace }}/llvm
      
      # ======================================
      # نصب vcpkg و وابستگی‌ها
      # ======================================
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '962e5e39f8a25f42522f51fffc574e05a3efc4c6'
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          runVcpkgInstall: false
      
      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/vcpkg_cache
            ${{ github.workspace }}/vcpkg_installed
          key: vcpkg-windows-x64-static-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-windows-x64-static-
      
      - name: Install vcpkg dependencies
        shell: pwsh
        run: |
          $env:VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
          & "$env:VCPKG_ROOT/vcpkg.exe" install opus:x64-windows-static libvpx:x64-windows-static libyuv:x64-windows-static --triplet=x64-windows-static
          
          # نمایش فایل‌های نصب شده
          Write-Host "=== Installed files ==="
          Get-ChildItem -Recurse "${{ github.workspace }}/vcpkg/installed/x64-windows-static/include" -ErrorAction SilentlyContinue | Select-Object FullName
      
      # ======================================
      # تنظیم متغیرهای محیطی
      # ======================================
      - name: Set environment variables
        shell: pwsh
        run: |
          $vcpkgRoot = "${{ github.workspace }}/vcpkg"
          $vcpkgInstalled = "$vcpkgRoot/installed/x64-windows-static"
          
          # تنظیم متغیرها
          echo "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
          echo "VCPKGRS_TRIPLET=x64-windows-static" >> $env:GITHUB_ENV
          echo "VCPKGRS_DYNAMIC=0" >> $env:GITHUB_ENV
          
          echo "LIBCLANG_PATH=${{ github.workspace }}/llvm/bin" >> $env:GITHUB_ENV
          echo "LLVM_CONFIG_PATH=${{ github.workspace }}/llvm/bin/llvm-config" >> $env:GITHUB_ENV
          
          echo "OPUS_INCLUDE_DIR=$vcpkgInstalled/include" >> $env:GITHUB_ENV
          echo "OPUS_LIB_DIR=$vcpkgInstalled/lib" >> $env:GITHUB_ENV
          
          # اضافه به PATH
          echo "$vcpkgInstalled/bin" >> $env:GITHUB_PATH
          echo "${{ github.workspace }}/llvm/bin" >> $env:GITHUB_PATH
          
          Write-Host "=== Environment configured ==="
          Write-Host "VCPKG_ROOT: $vcpkgRoot"
          Write-Host "OPUS headers: $vcpkgInstalled/include"
      
      # ======================================
      # بیلد Rust
      # ======================================
      - name: Build Rust library
        shell: pwsh
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
          VCPKGRS_TRIPLET: x64-windows-static
          VCPKGRS_DYNAMIC: "0"
          LIBCLANG_PATH: ${{ github.workspace }}/llvm/bin
        run: |
          Write-Host "=== Starting Rust build ==="
          
          # بررسی وجود هدرها
          $opusHeader = "$env:VCPKG_ROOT/installed/x64-windows-static/include/opus/opus.h"
          if (Test-Path $opusHeader) {
              Write-Host "✓ opus.h found at: $opusHeader"
          } else {
              Write-Host "✗ opus.h NOT found!"
              Get-ChildItem -Recurse "$env:VCPKG_ROOT/installed" -Filter "opus.h" | Select-Object FullName
          }
          
          cargo build --release --features hwcodec
      
      # ======================================
      # بیلد Flutter
      # ======================================
      - name: Build Flutter Windows
        working-directory: flutter
        run: |
          flutter config --enable-windows-desktop
          flutter pub get
          flutter build windows --release
      
      # ======================================
      # آپلود artifact
      # ======================================
      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: DezhTech-Remote-Windows
          path: flutter/build/windows/x64/runner/Release/
          retention-days: 30
