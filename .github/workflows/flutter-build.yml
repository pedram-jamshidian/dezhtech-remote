name: Flutter Windows Build

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ======================================
      # نصب ابزارها
      # ======================================
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "15.0"
          directory: ${{ github.workspace }}/llvm

      # ======================================
      # vcpkg - نصب از manifest
      # ======================================
      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/vcpkg_installed
            C:/vcpkg/downloads
          key: vcpkg-win-static-md-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-win-static-md-

      - name: Install vcpkg dependencies (manifest mode)
        shell: pwsh
        run: |
          Write-Host "=== vcpkg manifest install ==="
          $env:VCPKG_ROOT = "C:\vcpkg"
          
          # نصب از vcpkg.json (manifest mode) - بدون نام پکیج
          & C:\vcpkg\vcpkg.exe install --triplet x64-windows-static-md --x-install-root "${{ github.workspace }}/vcpkg_installed"
          
          Write-Host "=== Checking installed files ==="
          Get-ChildItem -Recurse "${{ github.workspace }}/vcpkg_installed" -Filter "opus.h" -ErrorAction SilentlyContinue | Select-Object FullName
          Get-ChildItem -Recurse "${{ github.workspace }}/vcpkg_installed" -Filter "opus.lib" -ErrorAction SilentlyContinue | Select-Object FullName

      # ======================================
      # متغیرهای محیطی
      # ======================================
      - name: Set environment variables
        shell: pwsh
        run: |
          $vcpkgInstalled = "${{ github.workspace }}/vcpkg_installed/x64-windows-static-md"
          
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          echo "VCPKGRS_TRIPLET=x64-windows-static-md" >> $env:GITHUB_ENV
          echo "VCPKGRS_DYNAMIC=0" >> $env:GITHUB_ENV
          
          echo "LIBCLANG_PATH=${{ github.workspace }}/llvm/bin" >> $env:GITHUB_ENV
          echo "LLVM_CONFIG_PATH=${{ github.workspace }}/llvm/bin/llvm-config" >> $env:GITHUB_ENV
          
          echo "OPUS_INCLUDE_DIR=$vcpkgInstalled/include" >> $env:GITHUB_ENV
          echo "OPUS_LIB_DIR=$vcpkgInstalled/lib" >> $env:GITHUB_ENV
          
          echo "${{ github.workspace }}/llvm/bin" >> $env:GITHUB_PATH
          
          Write-Host "=== Environment configured ==="
          Write-Host "OPUS headers: $vcpkgInstalled/include"

      # ======================================
      # بررسی پیش از بیلد
      # ======================================
      - name: Verify dependencies
        shell: pwsh
        run: |
          Write-Host "=== Verification ==="
          
          $opusH = "${{ github.workspace }}/vcpkg_installed/x64-windows-static-md/include/opus/opus.h"
          if (Test-Path $opusH) {
              Write-Host "✓ opus.h found"
          } else {
              Write-Host "✗ opus.h NOT found at expected path"
              Write-Host "Searching everywhere..."
              Get-ChildItem -Recurse "${{ github.workspace }}/vcpkg_installed" -Filter "opus.h" -ErrorAction SilentlyContinue | Select-Object FullName
          }
          
          # بررسی LLVM
          if (Test-Path "${{ github.workspace }}/llvm/bin/clang.exe") {
              Write-Host "✓ clang.exe found"
          } else {
              Write-Host "✗ clang.exe NOT found"
          }
          
          rustc --version
          cargo --version
          flutter --version

      # ======================================
      # بیلد Rust
      # ======================================
      - name: Build Rust library
        shell: pwsh
        env:
          VCPKG_ROOT: C:\vcpkg
          VCPKGRS_TRIPLET: x64-windows-static-md
          VCPKGRS_DYNAMIC: "0"
          LIBCLANG_PATH: ${{ github.workspace }}/llvm/bin
          OPUS_INCLUDE_DIR: ${{ github.workspace }}/vcpkg_installed/x64-windows-static-md/include
          OPUS_LIB_DIR: ${{ github.workspace }}/vcpkg_installed/x64-windows-static-md/lib
        run: |
          Write-Host "=== Starting Rust build ==="
          cargo build --release --features hwcodec

      # ======================================
      # بیلد Flutter
      # ======================================
      - name: Build Flutter Windows
        working-directory: flutter
        run: |
          flutter config --enable-windows-desktop
          flutter pub get
          flutter build windows --release

      # ======================================
      # آپلود artifact
      # ======================================
      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: DezhTech-Remote-Windows
          path: flutter/build/windows/x64/runner/Release/
          retention-days: 30
