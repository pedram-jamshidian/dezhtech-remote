name: Build DezhTech Remote - Windows Full

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'

env:
  SCITER_RUST_VERSION: "1.75.0"
  RUST_VERSION: "1.75.0"
  CARGO_NDK_VERSION: "3.1.2"
  LLVM_VERSION: "15.0.6"
  FLUTTER_VERSION: "3.24.0"
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
  CARGO_INCREMENTAL: "0"
  SCCACHE_GHA_ENABLED: "true"
  RUSTC_WRAPPER: "sccache"

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-2022

    steps:
      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-pc-windows-msvc
          components: rustfmt, clippy

      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.4

      - name: Setup vcpkg with GitHub Actions binary caching
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 120deac3062162151622ca4860575a33844ba10b

      - name: Install vcpkg dependencies
        run: |
          $VCPKG_ROOT/vcpkg install --x-install-root="$VCPKG_ROOT/installed" --triplet x64-windows-static-md
        shell: bash
        env:
          VCPKG_DEFAULT_HOST_TRIPLET: x64-windows-static-md

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: ${{ env.LLVM_VERSION }}

      - name: Flutter pub get
        working-directory: flutter
        run: flutter pub get

      - name: Restore bridge files
        uses: aspect-build/bazel-lib/.github/actions/run_or_restore@v2.7.7
        id: restore-bridge
        with:
          path: |
            ./src/flutter_ffi.rs
            ./flutter/lib/generated_bridge.dart
            ./flutter/lib/generated_bridge.freezed.dart
          key: bridge-${{ hashFiles('./src/bridge_generated.rs', './Cargo.lock', './flutter/pubspec.lock') }}
          run: |
            dart pub global activate ffigen
            $env:FFIGEN_LLVM = "${{ env.LLVM_PATH }}"
            flutter_rust_bridge_codegen --rust-input ./src/bridge_generated.rs --dart-output ./flutter/lib/generated_bridge.dart

      - name: Build Rust library
        run: cargo build --lib --features "flutter" --release
        env:
          VCPKG_ROOT: ${{ env.VCPKG_ROOT }}
          LIBCLANG_PATH: ${{ env.LLVM_PATH }}/lib

      - name: Build Flutter Windows
        working-directory: flutter
        run: flutter build windows --release

      - name: Prepare release package
        shell: pwsh
        run: |
          $version = Get-Date -Format "yyyy.MM.dd"
          $buildDir = "flutter/build/windows/x64/runner/Release"
          $outputDir = "DezhTech-Remote-$version"
          
          New-Item -ItemType Directory -Path $outputDir -Force
          Copy-Item -Path "$buildDir/*" -Destination $outputDir -Recurse -Force
          
          # Create version file
          @"
          DezhTech Remote
          Version: $version
          Build: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          "@ | Set-Content "$outputDir/VERSION.txt"
          
          Compress-Archive -Path "$outputDir/*" -DestinationPath "DezhTech-Remote-Windows-$version.zip"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DezhTech-Remote-Windows
          path: |
            DezhTech-Remote-*.zip
            flutter/build/windows/x64/runner/Release/
          retention-days: 30
